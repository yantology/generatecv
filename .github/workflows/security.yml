name: Security Scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 12 */3 * *'  # Every 3 days at 12:00
  workflow_dispatch:

jobs:
  security:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
    
    - name: Install UV
      uses: astral-sh/setup-uv@v6
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"
    
    - name: Install dependencies
      run: uv sync --dev
    
    - name: Initialize security report
      run: |
        echo "# ðŸ” Security Scan Report" > security-report.md
        echo "" >> security-report.md
        echo "**Scan Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> security-report.md
        echo "**Repository:** ${{ github.repository }}" >> security-report.md
        echo "**Branch:** ${{ github.ref_name }}" >> security-report.md
        echo "**Commit:** ${{ github.sha }}" >> security-report.md
        echo "" >> security-report.md
    
    - name: Run vulnerability scan with Safety
      id: vulnerability_scan
      run: |
        uv add --dev safety
        echo "## ðŸš¨ Dependency Vulnerabilities" >> security-report.md
        echo "" >> security-report.md
        
        if uv run safety check --json --output vulns.json 2>/dev/null; then
          echo "âœ… **No known vulnerabilities found in dependencies!**" >> security-report.md
          echo "has_vulns=false" >> $GITHUB_OUTPUT
        else
          echo "âŒ **Vulnerabilities detected in dependencies:**" >> security-report.md
          echo "" >> security-report.md
          echo '```' >> security-report.md
          uv run safety check 2>&1 | head -50 >> security-report.md
          echo '```' >> security-report.md
          echo "has_vulns=true" >> $GITHUB_OUTPUT
        fi
        echo "" >> security-report.md
    
    - name: Run code security scan with Bandit
      id: code_scan
      run: |
        uv add --dev bandit[toml]
        echo "## ðŸ” Code Security Analysis" >> security-report.md
        echo "" >> security-report.md
        
        if uv run bandit -r src/ -f json -o bandit.json 2>/dev/null; then
          echo "âœ… **No code security issues found!**" >> security-report.md
          echo "has_code_issues=false" >> $GITHUB_OUTPUT
        else
          echo "âŒ **Code security issues detected:**" >> security-report.md
          echo "" >> security-report.md
          echo '```' >> security-report.md
          uv run bandit -r src/ -f txt 2>&1 | head -30 >> security-report.md
          echo '```' >> security-report.md
          echo "has_code_issues=true" >> $GITHUB_OUTPUT
        fi
        echo "" >> security-report.md
    
    - name: Add scan summary
      run: |
        echo "## ðŸ“Š Scan Summary" >> security-report.md
        echo "" >> security-report.md
        echo "- **Dependencies scanned:** $(uv run python -c "import pkg_resources; print(len(list(pkg_resources.working_set)))" 2>/dev/null || echo "N/A")" >> security-report.md
        echo "- **Python files scanned:** $(find src/ -name "*.py" | wc -l)" >> security-report.md
        echo "- **Vulnerabilities found:** ${{ steps.vulnerability_scan.outputs.has_vulns == 'true' && 'Yes' || 'No' }}" >> security-report.md
        echo "- **Code issues found:** ${{ steps.code_scan.outputs.has_code_issues == 'true' && 'Yes' || 'No' }}" >> security-report.md
        echo "" >> security-report.md
        echo "---" >> security-report.md
        echo "*This report was generated automatically by the security scanning workflow.*" >> security-report.md
    
    - name: Upload security reports as artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports-${{ github.run_id }}
        path: |
          security-report.md
          vulns.json
          bandit.json
        retention-days: 30
    
    - name: Save security report to repository
      if: github.ref == 'refs/heads/main' && (steps.vulnerability_scan.outputs.has_vulns == 'true' || steps.code_scan.outputs.has_code_issues == 'true')
      run: |
        mkdir -p .github/security-reports
        cp security-report.md .github/security-reports/$(date +%Y-%m-%d-%H%M).md
        
        git config user.name "security-bot[bot]"
        git config user.email "security-bot[bot]@users.noreply.github.com"
        git add .github/security-reports/
        git commit -m "ðŸ“Š Security scan report $(date +%Y-%m-%d)" || exit 0
        git push
    
    - name: Close existing security issues
      if: steps.vulnerability_scan.outputs.has_vulns == 'true' || steps.code_scan.outputs.has_code_issues == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'security-scan',
            state: 'open'
          });
          
          for (const issue of issues) {
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: 'closed',
              state_reason: 'completed'
            });
          }
    
    - name: Create GitHub Issue for security findings
      if: steps.vulnerability_scan.outputs.has_vulns == 'true' || steps.code_scan.outputs.has_code_issues == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const reportContent = fs.readFileSync('security-report.md', 'utf8');
          
          const priority = '${{ steps.vulnerability_scan.outputs.has_vulns }}' === 'true' ? 'high-priority' : 'medium-priority';
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ðŸš¨ Security Alert - ${new Date().toISOString().split('T')[0]}`,
            body: `${reportContent}
            
            ---
            **Workflow Run:** [${context.workflow}](${context.payload.repository.html_url}/actions/runs/${context.runId})
            **Triggered by:** ${context.eventName}
            **Actor:** ${context.actor}
            
            > âš ï¸ This issue was automatically created by security scanning workflow.
            > Please review and address the findings above.`,
            labels: ['security-scan', 'automated', priority, 'needs-triage']
          });